(function(rt){var templates=rt.templates,attrs=function(){return rt.attrs.apply(rt,arguments)},_=function(){return rt._.apply(rt,arguments)},img=function(){return rt.img.apply(rt,arguments)},imgURL=function(){return rt.imgURL.apply(rt,arguments)},museImgUrl=function(){return rt.museImgUrl.apply(rt,arguments)},gifURL=function(){return rt.gifURL.apply(rt,arguments)},meiwuCopyrightUrl=function(){return rt.meiwuCopyrightUrl.apply(rt,arguments)},imgSuffixIsRetinaDisplay=function(){return rt.imgSuffixIsRetinaDisplay.apply(rt,arguments)},imgSize=function(){return rt.imgSize.apply(rt,arguments)},avatar=function(){return rt.avatar.apply(rt,arguments)},isVerified=function(){return rt.isVerified.apply(rt,arguments)},url=function(){return rt.url.apply(rt,arguments)},parseURL=function(){return rt.parseURL.apply(rt,arguments)},mkurl=function(){return rt.mkurl.apply(rt,arguments)},GACampaignURL=function(){return rt.GACampaignURL.apply(rt,arguments)},format_text=function(){return rt.format_text.apply(rt,arguments)},escape=function(){return rt.escape.apply(rt,arguments)},__t=rt.templates,emerge=function(){return rt.renderSync.apply(rt,arguments)};__t["dialog_box/alert"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp,msgs=locals.text.split("$$"),text=msgs[0],extraHeader=null,extraContent=null;msgs.length>=3&&(extraHeader=msgs[1],extraContent=msgs[2]),buf.push("<div"),buf.push(attrs({"class":"dialog-overlay alert"})),buf.push("></div><div"),buf.push(attrs({id:"dialog_alert","data-name":"alert","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">"+escape((interp=locals.title||"提示")==null?"":interp)+"</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"info-text"})),buf.push("><i"),buf.push(attrs({"class":"icon-"+(locals.type||"caution")+""})),buf.push("></i>");var __val__=text;buf.push(null==__val__?"":__val__),buf.push("</div><div"),buf.push(attrs({"class":"info-extra"})),buf.push(">");if(extraHeader){buf.push("<div"),buf.push(attrs({"class":"header"})),buf.push(">");var __val__=extraHeader;buf.push(escape(null==__val__?"":__val__)),buf.push("</div>")}if(extraContent){buf.push("<div"),buf.push(attrs({"class":"content"})),buf.push(">");var __val__=extraContent;buf.push(escape(null==__val__?"":__val__)),buf.push("</div>")}buf.push("</div></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push(">"),extraHeader&&(buf.push("<div"),buf.push(attrs({"class":"contact-us"})),buf.push(">如有问题？请<a"),buf.push(attrs({id:"contactus",onclick:"app.use_qiyu()","class":"brown-link"})),buf.push(">联系我们</a></div>")),buf.push("<div"),buf.push(attrs({"class":"buttons"})),buf.push(">"),locals.cancelButton&&(buf.push("<a"),buf.push(attrs({href:"#",onclick:"return false;","class":"cancel btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a>")),buf.push("<a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> "+escape((interp=locals.action||"确定")==null?"":interp)+"</span></a></div></div>"),locals.closeButton&&(buf.push("<div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div>")),buf.push('</div><script>(function(){var e=document.id("dialog_alert"),t=e.getElements(".box-bottom .btn, .close-btn");t.addEvent("click",function(t){var n=!!this.hasClass("action");e.fireEvent("confirm",window.captchaObj&&captchaObj.getValidate()||n),app.hideDialogBox("alert"),t.stop()})})()</script>')}return buf.join("")},__t["dialog_box/board_edit"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"board_edit_dialog","data-name":"board_edit","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({id:"pin_edit_form","class":"Form StaticForm Dialog Dialog_board"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">编辑画板</div><ul><li><label"),buf.push(attrs({"for":"id_title"})),buf.push(">标题</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><input"),buf.push(attrs({type:"text",name:"title",id:"id_title",placeholder:"为你的画板取个名字","class":"clear-input"})),buf.push("/></div></li><li><label"),buf.push(attrs({"for":"id_description"})),buf.push(">描述</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><textarea"),buf.push(attrs({id:"id_description",rows:"3",cols:"40",name:"description",placeholder:"画板简介（最多 255 字）",maxlength:"255","class":"clear-input"})),buf.push("></textarea></div></li><li><label>分类</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><input"),buf.push(attrs({type:"hidden",name:"category",id:"id_category","class":"clear-input"})),buf.push("/>");var __val__=emerge("base/category_picker");buf.push(null==__val__?"":__val__),buf.push("</div></li></ul></div><div"),buf.push(attrs({"class":"op"})),buf.push("><div"),buf.push(attrs({id:"board_delete","class":"Delete"})),buf.push(">删除画板</div><div"),buf.push(attrs({"class":"Confirm"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 确认</span></a></div><div"),buf.push(attrs({"class":"Cancle"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("board_edit_dialog"),t="'+escape((interp=locals.board_id)==null?"":interp)+'",n=document.id("id_title"),r=document.id("id_description"),i=e.getElement(".CurrentBoard"),s=e.getElement(".Cancle a");n.focus(),(new Request.JSON({url:"/boards/"+t+"/",onSuccess:function(e){if(e.err){alert(e.msg||app.COMMON_ERRMSG),btn.setTitle().enable();return}var t=e.board;i.setAttribute("data",t.category_id),s.onclick=function(){return app.hideDialogBox("board_edit"),!1},t.title&&(n.value=t.title),t.description&&(r.value=t.description),t.category_name&&t.category_id&&(i.value=t.category_id,i.innerText=t.category_name)},onFailure:function(){btn.setTitle().enable()}})).get();var o=new CategoryPicker(e.getElement("div.CategoryPicker"));o.select(i.get("value")),new Button(e.getElement(".Confirm a.btn"),{click:function(){var e=n.get("value").trim();if(e=="")return app.showTip(n,"请输入名称",{width:150});if(e.length>32)return app.showTip(n,"画板名称不能超过 32 个字符",{width:150});var i=o.getSelected();return i==="null"?app.showTip(o.element,"请选择分类",{width:150}):(this.disable(),(new Request.JSON({url:"/boards/"+t+"/",data:{title:e,description:r.get("value"),category:i},onSuccess:function(e){e.err?app.error(e.msg):app.hideDialogBox("board_edit")},onFailure:function(){app.error("网络错误，请稍候再试")},onComplete:function(){this.enable()}.bind(this)})).post(),!1)}}),o.addEvent("select",function(){app.hideTip(o.element)}),$$("input").addEvent("blur",function(e){app.hideTip(e.target)});var u=document.id("board_delete");new Button(u,{click:function(){var e=this;return app.confirm({text:"确定要删除这个画板吗？删除后这个画板内的所有采集都会被删除。",action:"删除"},function(n){if(!n)return;e.setTitle("正在删除...").disable(),(new Request.JSON({url:"/boards/"+t+"/",data:{_method:"DELETE"},onSuccess:function(n){if(n.err){app.error(n.msg||app.COMMON_ERRMSG),e.setTitle().enable();return}var r=\'[data-id="\'+t+\'"]\',i=document.querySelector(r);i?i.classList.add("Board_deleted"):window.location.pathname="/"+app.req.user.urlname,app.hideDialogBox("board_edit")},onFailure:function(){e.setTitle().enable()}})).post()}),!1}})})()</script>')}return buf.join("")},__t["dialog_box/chrome_addon"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"chrome_addon_download_tip",style:"width: 720px; margin-left: -360px;","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">安装花瓣扩展小窍门</div><div"),buf.push(attrs({"class":"box-inner clearfix"})),buf.push("><div"),buf.push(attrs({"class":"step step1"})),buf.push("><div"),buf.push(attrs({"class":"title"})),buf.push(">1.打开浏览器扩展程序页面</div><img"),buf.push(attrs({src:"/img/chrome_notice_step_1.png","data-baiduimageplus-ignore":1})),buf.push("/></div><div"),buf.push(attrs({"class":"step step2"})),buf.push("><div"),buf.push(attrs({"class":"title"})),buf.push(">2.打开右上角的“开发者模式”</div><img"),buf.push(attrs({src:"/img/chrome_notice_step_2.png","data-baiduimageplus-ignore":1})),buf.push("/></div><div"),buf.push(attrs({"class":"step step3"})),buf.push("><div"),buf.push(attrs({"class":"title"})),buf.push(">3.将扩展文件拖动到该页面</div><img"),buf.push(attrs({src:"/img/chrome_notice_step_3.png","data-baiduimageplus-ignore":1})),buf.push("/></div></div><div"),buf.push(attrs({"class":"tips"})),buf.push(">遇到问题？点击页面右下角联系人工客服</div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div>")}return buf.join("")},__t["dialog_box/create_board"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"CreateBoard","class":"dialog-box "+(typeof className=="undefined"?"":" "+className)})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">新建画板</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><form"),buf.push(attrs({action:"","class":"Form StaticForm nm"})),buf.push("><div"),buf.push(attrs({id:"switcher",style:"display: none;","class":"switcher"})),buf.push("><label"),buf.push(attrs({"class":"label"})),buf.push("><input"),buf.push(attrs({type:"radio",name:"creation",value:"true"})),buf.push("/>原创画板</label><label"),buf.push(attrs({"class":"label"})),buf.push("><input"),buf.push(attrs({type:"radio",name:"creation",value:"false",checked:!0})),buf.push("/>普通画板</label></div><ul><li"),buf.push(attrs({"class":"nbt"})),buf.push("><input"),buf.push(attrs({id:"id_board_title",type:"text",name:"title",value:"",placeholder:"画板标题，不能超过 32 个字符","class":"clear-input"})),buf.push("/><span"),buf.push(attrs({"class":"fff"})),buf.push("></span></li><li><input"),buf.push(attrs({id:"id_category",type:"hidden",name:"category",value:""})),buf.push("/>");var __val__=emerge("base/category_picker");buf.push(null==__val__?"":__val__),buf.push("</li></ul><div"),buf.push(attrs({id:"info",style:"display: none;","class":"common-message info"})),buf.push(">原创画板只能上传原创作品，不能收集转采的采集</div></form></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"reject btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action Submit btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 创建画板</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=$("CreateBoard");if(e.retrieve("initialized"))return;var t=document.id("CreateBoard"),n=$("id_board_title"),r=e.getElement(".CategoryPicker"),i=new CategoryPicker(r),s=$("switcher"),o=$("info");t.getElement(".box-bottom .buttons .reject").addEvent("click",function(){app.hideDialogBox("create_board")}),t.getElements("input[type=radio]").addEvent("change",function(e){var t=e.target,n=t.get("value").trim();"true"===n?o.show():o.hide()}),new Button(e.getElement(".Submit"),{click:function(){var e=n.get("value").trim();if(e=="")return app.showTip(n,"请输入名称",{width:150});if(e.length>32)return app.showTip(n,"画板名称不能超过 32 个字符",{width:150});var r=i.getSelected();if(!r)return app.showTip(i.element,"请选择分类",{width:150});this.disable();var s=t.getElement("input[type=radio]:checked").get("value").trim();return(new Request.JSON({url:"/boards/",data:{title:e,category:r,creation:s},onSuccess:function(e){e.err?app.error(e.msg):app.page.$userTask&&app.page.$userTask.isShowing?(app.hideDialog(),app.page.$userTask.resetOverlay(),app.page.$userTask.showModule("step1-5")):window.location="/boards/"+e.board.board_id+"/"},onFailure:function(){app.error(app.COMMON_ERRMSG)},onComplete:function(){this.enable()}.bind(this)})).post(),!1}}),i.addEvent("select",function(){app.hideTip(i.element)}),e.getElements("input").addEvent("blur",function(e){app.hideTip(e.target)}),(new Request.JSON({url:"/muse/me/status/",onSuccess:function(e){if(e.hasOwnProperty("err"))return app.alert(e.msg);if(!e.isMuseUser)return;s.show(),o.show(),s.getElement("input").set("checked","checked")},onError:function(e){console.error(e)}})).get(),e.store("initialized",!0)})(),function(){var e=document.id("CreateBoard");e&&e.getElement(".Form").addEvent("submit",function(){return e.getElement(".Submit").click(),!1})}()</script>')}return buf.join("")},__t["dialog_box/create_pin"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"create_pin","data-name":"upload","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">"+escape((interp=locals.title||"新采集")==null?"":interp)+"</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push(">");var __val__=emerge("base/pin_create",locals);buf.push(null==__val__?"":__val__),buf.push("</div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div>")}return buf.join("")},__t["dialog_box/dm"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({id:"dm_box"})),buf.push("><div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({"class":"dialog-box list-view"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">私信<div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"conversation-list"})),buf.push("></div><div"),buf.push(attrs({"class":"bottom"})),buf.push("></div><div"),buf.push(attrs({"class":"empty hidden"})),buf.push("><h2>现在你可以发送私信啦！</h2><div"),buf.push(attrs({"class":"sub"})),buf.push(">要发送私信，请到该用户主页，点击私信按钮</div><img"),buf.push(attrs({src:"/img/send_msg_intr.jpg","data-baiduimageplus-ignore":1})),buf.push("/></div></div></div><div"),buf.push(attrs({style:"display:none","class":"dialog-box dialog-view"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push("><a"),buf.push(attrs({"class":"brown-link back"})),buf.push(">私信</a><span"),buf.push(attrs({"class":"dialog-only-text"})),buf.push(">私信给</span><img"),buf.push(attrs({src:"/img/arrow_to_right.svg","data-baiduimageplus-ignore":1,"class":"symbol"})),buf.push("/><span"),buf.push(attrs({"class":"with-user-name"})),buf.push(">呵呵</span><img"),buf.push(attrs({"data-baiduimageplus-ignore":1,"class":"user-icon"})),buf.push("/><div"),buf.push(attrs({"class":"action"})),buf.push("><div"),buf.push(attrs({"class":"open"})),buf.push("></div><ul><li"),buf.push(attrs({"class":"block"})),buf.push(">屏蔽此人</li></ul></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><a"),buf.push(attrs({style:"display: none",href:"#",onclick:"return false;","class":"load more btn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 加载上条消息</span></a><div"),buf.push(attrs({"class":"messages"})),buf.push("></div><div"),buf.push(attrs({"class":"send-box clearfix"})),buf.push("><textarea"),buf.push(attrs({"class":"clear-input"})),buf.push("></textarea><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"send disabled btn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push('> 发送私信</span></a></div></div></div></div><script>(function(){var e=new Class({options:{interval:3e4,listLimit:20},initialize:function(e){this.nowOnDialog=null;var t=this,e=this.mainEl=$(e);this.listView=e.getElement(".dialog-box.list-view"),this.listEl=this.listView.getElement(".conversation-list"),this.dialogView=e.getElement(".dialog-box.dialog-view"),this.dialogEl=this.dialogView.getElement(".messages"),this.indicator=document.getElements("#nav_user .dm-nav .num"),this.listLoadingEl=new Element("div.loding-more"),this.loadMoreBtn=this.dialogView.getElement(".load.more"),[this.dialogEl,this.listEl].each(function(e){stopWindowScroll(e)}),e.addEvent("click:relay(.dialog-overlay, .close-btn)",function(e){t.hide(),e.stop()}),e.addEvent("click:relay(.action .open)",function(e){t.mainEl.getElements(".action").removeClass("active"),this.getParent(".action").addClass("active")}),e.addEvent("click:relay(.conversation-list .conversation)",function(e){if(e.target.getParent(".action")||e.target.getParent(".avt"))return;t.showDialog({username:this.get("data-with-user-name"),user_id:this.get("data-with-user-id")}),this.hasClass("unread")&&(this.removeClass("unread"),t.decreaseIndicator())}),e.addEvent("click",function(e){if(e.target.match(".action .open"))return;t.mainEl.getElements(".action").removeClass("active")});var n=0;e.addEvent("click:relay(.system-message .unfold-box)",function(e){if(n)return;n=1,setTimeout(function(){n=0},500);var t=e.target.className==="unfold-box"?e.target:e.target.parentNode,r=t.parentNode,i=t.getElement(".unfold-box-text"),s=t.getElement(".unfold-box-btn"),o=r.getElement(".message-show"),u=r.getElement(".message-hide"),a=u.getElement(".title"),f=a?a.innerText:"",l=r.get("data-folder"),c=(new Element("div",{"class":"message-show",styles:{visibility:"hidden",position:"fixed",height:"auto"},html:o.innerHTML})).inject(r),h=c.getElements("img"),p=0;h.forEach(function(e){e.destroy()}),c.style.width=o.clientWidth+"px";var d=c.clientHeight+344*h.length;c.destroy(),l==="1"?(i.innerText="收起",s.src="/img/folder.svg",o.style.opacity=1,o.style.height=d+"px",setTimeout(function(){u.style.opacity=0},300),r.set("data-folder",0),f&&setTimeout(function(){u.style.height=0},400)):(i.innerText="展开",s.src="/img/unfolder.svg",o.style.height=0,o.style.opacity=0,u.style.height="24px",setTimeout(function(){u.style.opacity=1},500),r.set("data-folder",1))}),this.dialogView.getElement(".box-title .back").addEvent("click",function(){if(t.nowOnDialog&&t.nowOnDialog.modified){var e=t.nowOnDialog.user_id;return t.reposition(e)}t.showList()}),e.addEvent("click:relay(.action .block)",function(){var e=this.getParent(".conversation"),n=null;if(e)n=e.get("data-with-user-id");else{if(!t.nowOnDialog)return;n=t.nowOnDialog.user_id}app.confirm("确定屏蔽此人？屏蔽后对方无法再向你发送私信。你可以在帐号设置页面中解除对他的屏蔽。",function(r){if(!r)return;(new Request.JSON({url:"/dm/block/",data:{user_id:n},onSuccess:function(r){if(r.err)return app.error(app.COMMON_ERRMSG);e?e.fade("out").get("tween").chain(function(){e.dispose()}):t.nowOnDialog&&(t.removeConversation(n),t.showList())},onFailure:function(){app.error(app.COMMON_ERRMSG)}})).post()})}),e.addEvent("click:relay(.report)",function(){return window.report_type="dm",window.report_id=this.getParent(".message").get("data-dm-id"),app.showDialog("report"),!1});var r=e.getElement(".send-box"),i=this.textarea=r.getElement("textarea"),s=this.sendButton=r.getElement(".send"),t=this;i.addEvents({keyup:function(){this.value.clean()?s.removeClass("disabled"):s.addClass("disabled")},keydown:function(e){if(e.key=="enter"&&(e.control||e.meta))return s.fireEvent("click"),!1}}),s.addEvent("click",function(){if(!i.value.clean())return;var e=i.value;i.value="",t.insertConversation({text:e,created_at:new Date/1e3}),t.dialogEl.scrollTo(0,t.dialogEl.scrollHeight),i.focus();var n=t.nowOnDialog.user_id;(new Request.JSON({url:"/dm/send/",data:{to_user_id:n,text:e},onSuccess:function(e){if(e.err)return app.error(e.msg||app.COMMON_ERRMSG);t.updateConversation(n,e)},onFailure:function(){app.error(app.COMMON_ERRMSG)}})).post(),t.nowOnDialog.modified=!0}),this.listEl.addEvent("scroll",function(e){this.getSize().y+this.getScroll().y>=this.scrollHeight&&t.loadList()}),this.loadMoreBtn.addEvent("click",function(){t.loadNextCoversation()}),Asset.image("/img/msg_loading.gif"),this.updateIndicator(app.req.unread_dm||0)},openFreshList:function(){this.showList(),this.refreshList(),this.fetch()},show:function(){this.isShowing=!0,this.mainEl.show()},hide:function(){this.isShowing=!1,this.mainEl.hide()},showList:function(){this.show(),this.listView.show(),this.dialogView.hide()},showDialog:function(e,t){this.show(),this.listView.hide(),this.nowOnDialog=e,this.dialogView.getElement(".with-user-name").innerHTML=e.username,this.dialogView.getElement(".user-icon").src=e.user_id==="system"?"/img/icon_admin.svg":"",this.dialogView.show(),this.refreshDialog();if(e.user_id=="system"){this.dialogView.addClass("system-dm");try{_czc.push(["_trackEvent","message","expose","",1])}catch(n){}}else this.dialogView.removeClass("system-dm"),this.textarea.focus();t?this.mainEl.addClass("dialog-only"):this.mainEl.removeClass("dialog-only")},showEmptyList:function(){this.listEl.getNext(".empty").clone().inject(this.listEl).removeClass("hidden")},refreshList:function(){var e=this;this.listEl.empty(),(new Request.JSON({url:"/dm/",data:{limit:e.options.listLimit},noCache:!0,onSuccess:function(t){t.conversations&&t.conversations.length?(t.conversations.each(function(t){var n=app.renderSync("base/dm_list_item",t),r=Elements.from(n).inject(e.listEl)}),t.conversations.length<e.options.listLimit&&e.listNoMore()):e.showEmptyList()}})).get()},loadList:function(e){if(this.listloading||this.listReachTheBottom)return;var t=this,e=this.listEl.getLast(".conversation").get("data-updated-at");this.showListLoadingMore(),this.listloading=!0,(new Request.JSON({url:"/dm/",data:{max:e,limit:t.options.listLimit},noCache:!0,onSuccess:function(e){t.hideListLoadingMore(),t.listloading=!1,e.conversations&&e.conversations.length&&e.conversations.each(function(e){var n=app.renderSync("base/dm_list_item",e),r=Elements.from(n).inject(t.listEl)}),(!e.conversations||e.conversations.length<t.options.listLimit)&&t.listNoMore()}})).get()},showListLoadingMore:function(){this.listLoadingEl.inject(this.listEl)},hideListLoadingMore:function(){this.listLoadingEl.dispose()},listNoMore:function(){this.listReachTheBottom=!0},refreshDialog:function(){var e=this.dialogEl,t=this.textarea,n=this.sendButton,r=this,i="/dm/messages/"+this.nowOnDialog.user_id+"/";e.removeClass("system-messages"),e.addClass("user-messages"),e.empty(),t.value="",n.addClass("disabled"),this.nowOnDialog.user_id=="system"&&(this.dialogEl.getNext().show(),i="/system_dm/"),(new Request.JSON({url:i,noCache:!0,onSuccess:function(n){n.blocked=="with_user blocked user"?((new Element("div.error-alert",{html:"<i></i>你已被对方屏蔽，不能发送私信"})).inject(e),t.set("disabled","disabled")):n.blocked=="user blocked with_user"?((new Element("div.error-alert",{html:\'<i></i>你已屏蔽此用户，可以在<a href="/settings/#set_blocked_conversations">帐号设置</a>中解除对他的屏蔽\'})).inject(e),t.set("disabled","disabled")):n.blocked=="user is banned"?((new Element("div.error-alert",{html:"<i></i>你的帐号已被禁止"})).inject(e),t.set("disabled","disabled")):n.blocked=="with_user is banned"?((new Element("div.error-alert",{html:"<i></i>此用户已被禁止"})).inject(e),t.set("disabled","disabled")):t.erase("disabled"),i==="/system_dm/"?r.loadConversations(n.messages.reverse()||[]):r.insertConversations(n.messages||[])}})).get()},fetch:function(){if(this.fetching)return;this.fetching=!0,(new Request.JSON({url:"/dm/unread/",noCache:!0,onSuccess:function(e){if(e.err)return;this.updateIndicator(e)}.bind(this),onComplete:function(){this.fetching=!1}.bind(this)})).get()},updateIndicator:function(e){this.indicator.set("text",e),e<=0?this.indicator.addClass("hidden"):this.indicator.removeClass("hidden")},decreaseIndicator:function(e){this.updateIndicator(--app.req.unread_dm)},updateConversation:function(e,t){var n=this.listEl.getElement(\'[data-with-user-id="\'+e+\'"]\');n.getElement(".content").set("text",t.text),n.getElement(".time").set({"data-ts":t.created_at,text:(new Date(t.created_at.toInt()*1e3)).timeAgo()})},removeConversation:function(e){return this.listEl.getElement(\'[data-with-user-id="\'+e+\'"]\').dispose()},reposition:function(e){var t=this.removeConversation(e);t.inject(this.listEl,"top"),this.showList()},_isShowTS:function(e,t){return t?e-t>=1800:!0},insertConversation:function(e){var t=this.dialogEl.getLast(".message"),n=app.renderSync("base/dm_dialog_item",{from_user:app.req.user,type:"sent",text:e.text,created_at:e.created_at,showTS:this._isShowTS(e.created_at,t&&t.get("data-ts"))});Elements.from(n).inject(this.dialogEl)},insertConversations:function(e){var t;for(var n=0;n<e.length;n++){if(!e[n])continue;var r=app.renderSync("base/dm_dialog_item",Object.merge(e[n],{showTS:this._isShowTS(e[n].created_at,e[n-1]&&e[n-1].created_at)}));t=Elements.from(r)[0].inject(this.dialogEl)}return t},insertBeforeCoversation:function(e,t){var n=app.renderSync("base/dm_dialog_item",Object.merge(e,{showTS:this._isShowTS(e.created_at,t&&t.created_at)})),r=Elements.from(n)[0].inject(this.dialogEl,"top");return r.addClass("fold"),r},loadConversations:function(e){function i(e,t,n,r){return n*Math.sin(e/r*(Math.PI/2))+t}var t=this.dialogEl;t.removeClass("user-messages"),t.addClass("system-messages"),this.cur=0,this.coversations=e;var n=this,r=this.coversations.length;if(!r)return;for(var s=0;s<r;s++){var o=n.insertBeforeCoversation(this.coversations[s]);o.addClass("unfold");if(s===0){var u=o;setTimeout(function(){u.getElement(".unfold-box").click()},100);var a=u.parentNode,f=800,l=+(new Date),c=(r-1)*66+10;setTimeout(function(){var e=setInterval(function(){var t=+(new Date),n=Math.min(t-l,f),r=i(n,0,c,f);a.scrollTo(0,r),r>=c&&clearInterval(e)},1e3/60)},150)}}},loadNextCoversation:function(){var e=this;if(this.cur>=this.coversations.length){this.loadMoreBtn.removeEvent("click",e.loadNextCoversation),this.loadMoreBtn.hide();return}this.dialogEl.scrollTo(0,0),++e.cur;var t=this.coversations[this.cur],n=e.insertBeforeCoversation(t);setTimeout(function(){n.addClass("unfold")},100)}});app.req.user&&(app.page.dmController=new e("dm_box"))})()</script>')}return buf.join("")},__t["dialog_box/edit"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"edit_dialog","data-name":"edit","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({id:"pin_edit_img"})),buf.push("><div"),buf.push(attrs({"class":"image"})),buf.push("><img"),buf.push(attrs({src:locals.media||"","data-baiduimageplus-ignore":1})),buf.push("/><input"),buf.push(attrs({type:"hidden",name:"pin_id",id:"id_pin_id"})),buf.push("/></div></div><div"),buf.push(attrs({id:"pin_edit_form",action:"",method:"post","class":"Form StaticForm Dialog"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">编辑采集</div><ul><li><label>标签</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><input"),buf.push(attrs({id:"tagarea",placeholder:"输入文字，按空格或回车以生成标签","class":"clear-input"})),buf.push("/></div></li><li><label>描述</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><div"),buf.push(attrs({id:"ta_holder","class":"editable_shadow pin_edit"})),buf.push("><textarea"),buf.push(attrs({rows:"2",name:"details",cols:"40",id:"description_pin_edit",placeholder:"描述这个采集（最多255字）",maxlength:"255","class":"clear-input expand autocomplete_desc"})),buf.push("></textarea></div></div></li><li><label"),buf.push(attrs({"for":"id_link"})),buf.push(">来源</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><input"),buf.push(attrs({type:"text",name:"link",id:"id_link",placeholder:"来源网站链接","class":"clear-input"})),buf.push("/></div></li><li><label"),buf.push(attrs({"for":"id_board"})),buf.push(">画板</label><div"),buf.push(attrs({"class":"Right"})),buf.push("><input"),buf.push(attrs({type:"hidden",name:"board_id",id:"id_board","class":"clear-input"})),buf.push("/><div"),buf.push(attrs({"class":"board-list"})),buf.push("><div"),buf.push(attrs({"class":"current"})),buf.push("><div"),buf.push(attrs({"class":"name"})),buf.push("></div><div"),buf.push(attrs({"class":"arrow"})),buf.push("></div></div><div"),buf.push(attrs({style:"display:none","class":"drop-list"})),buf.push("><div"),buf.push(attrs({"class":"boards"})),buf.push("></div><div"),buf.push(attrs({style:"display: none","class":"filtrate"})),buf.push("></div><div"),buf.push(attrs({"class":"filter"})),buf.push("><input"),buf.push(attrs({type:"text",placeholder:"快速筛选/创建画板","class":"clear-input"})),buf.push("/></div></div></div></div></li></ul></div><div"),buf.push(attrs({"class":"op"})),buf.push("><div"),buf.push(attrs({"class":"Delete"})),buf.push(">删除采集</div><div"),buf.push(attrs({"class":"Confirm"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 确认</span></a></div><div"),buf.push(attrs({"class":"Cancle"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div><script>(function(){var e=document.id("edit_dialog"),t="'+escape((interp=locals.pin_id)==null?"":interp)+'",n=document.id("tagarea"),r=e.getElement(".image img"),i=e.getElement(".image input"),s=e.getElement(".autocomplete_desc"),o=e.getElement(".board-list"),u=e.getElement(".name"),a=e.getElement(".Cancle a"),f=document.id("id_link"),l=document.id("pin_view_layer");n.focus(),(new Request.JSON({url:"/pins/"+t+"/",onSuccess:function(c){var h=c.pin;i.value=t,a.onclick=function(){app.hideDialogBox("edit")},r.src=app.imgURL(h.file,"fw236"),r.onload=function(){280<this.height&&this.getParent().addClass("blur")},n.value=c.pin.tags.join(",");var p=new TagInput(n);s.innerText=h.raw_text,f.value=h.link||"",f.disabled=h.original?"disabled":null;var d="",v="",m="",g=h.board;g&&g=="default"?m="use-default-board":g&&(d=g.board_id,v=g.title);var y=h.categorys?h.categorys+"":"";o.setProperty("data-board-id",d),o.addClass(m),u.textContent=v?v:"选择画板...",$$(".board-list:not(.inited)").each(function(e){var t=h.creation?!0:"",n=!1===h.boardCreatable?"false":"true",r=h.creationAll?"true":"";e.addClass("inited"),e.master=new BoardList(e,{creationOnly:!!t,boardCreatable:"false"===n?!1:!0,creationAll:!!r})}),new Button(e.getElement(".Confirm .btn"),{click:function(){if(h)var e={board_id:o.get("data-board-id"),text:s.value,link:f.value};e.tags=p.getValue();var n=this;return app.requireImportOldTags(function(){n.setTitle("保存中...").disable(),(new Request.JSON({url:"/pins/"+t+"/",data:e,onSuccess:function(e){if(e.err){alert(e.msg||app.COMMON_ERRMSG),n.setTitle().enable();return}app.hideDialogBox("edit")},onFailure:function(){n.setTitle().enable()}})).post()}),!1}}),new Button(e.getElement(".op .Delete"),{click:function(){var e=this;return app.confirm({title:"删除确认",text:"删除采集后不能恢复，确定要删除吗?",action:"删除"},function(n){n&&(e.setTitle("正在删除...").disable(),(new Request.JSON({url:"/pins/"+t+"/",data:{_method:"DELETE"},onSuccess:function(n){if(n.err){alert(n.msg||app.COMMON_ERRMSG),e.setTitle().enable();return}deletePin(t),l&&history.back(),app.hideDialogBox("edit")},onFailure:function(){e.setTitle().enable()}})).post())}),!1}})}})).get()})()</script></div>')}return buf.join("")},__t["dialog_box/import_old_tags"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"import-tags-dialog","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">导入旧版标签</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"description"})),buf.push(">我们在您的已有采集中发现了您可能需要的标签，您可以选择合适的标签导入。<br"),buf.push(attrs({})),buf.push("/>本操作为一次性操作，一旦完成则无法再次选择导入。</div></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"actions"})),buf.push("><a"),buf.push(attrs({"class":"act brown-link sel-all"})),buf.push(">全选</a><a"),buf.push(attrs({"class":"act brown-link unsel-all"})),buf.push(">取消选择</a></div><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"cancel btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 不导入</span></a><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 导入</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){function o(){t.getElements(".item").addClass("selected")}function u(){t.getElements(".item").removeClass("selected")}function a(){app.hideDialogBox("import_old_tags")}function f(){app.confirm("真的要取消导入？",function(e){e&&app.keepTags([],a)})}function l(e){var n=app.renderSync("base/tag_imports",{tags:e});Elements.from(n).inject(t)}function c(){var n=t.getElements(".item").length,r=t.getElements(".item.selected"),i=r.map(function(e){return e.get("data-tag")});if(!i.length)return app.alert("请至少选择 1 个标签");app.keepTags(i,function(){var t=r.length,n=\'<a href="/\'+app.req.user.urlname+\'/tags/">标签</a>\',s=t+" 个标签导入成功，您可以在个人主页的 "+n+" 选项卡查看。";app.alert(s),a();var o=new Date/1e3;Cookie.write("_imp_tag_t",parseInt(o)),e.fireEvent("confirm",{tags:i})})}var e=document.id("import-tags-dialog"),t=e.getElement(".box-inner"),n=e.getElement(".act.sel-all"),r=e.getElement(".act.unsel-all"),i=e.getElement(".action"),s=e.getElement(".cancel");(function(){var t=app.req.user;(new Request.JSON({url:"/"+t.urlname+"/tags/",onSuccess:function(e){if(e.err)return app.error(e.msg);l(e.tags)},onFailure:function(e){app.error(e.responseText||app.COMMON_ERRMSG)}})).get()})(),n.addEvent("click",o),r.addEvent("click",u),s.addEvent("click",f),i.addEvent("click",c),t.addEvent("click:relay(.item)",function(){this.toggleClass("selected")})})(),function(){_czc.push(["_trackEvent","tag","import",1]);var e=function(){_czc.push(["_trackEvent","tag","import-abort",1])},t=document.id("import-tags-dialog");t.getElement(".close-btn").addEvent("click",e),t.getPrevious(".dialog-overlay").addEvent("click",e)}()</script>')}return buf.join("")},__t["dialog_box/limiter"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"dialog_limiter","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">提示</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"info-text"})),buf.push("><i"),buf.push(attrs({"class":"icon caution"})),buf.push("></i>"+escape((interp=text)==null?"":interp)+"</div><div"),buf.push(attrs({id:"limiter-captcha","class":"captcha"})),buf.push("></div></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push('> 确定</span></a></div></div></div><script>(function(){function i(){if(!n||!n.sig)return app.alert("请先完成验证",function(){app.hideDialogBox("limiter")});(new Request({url:"/captcha/rater",data:{key:r,type:"limit",validate:n},onSuccess:function(){app.alert("验证成功，请继续完成后续操作"),app.hideDialogBox("limiter")},onFailure:function(e){app.error(e.response)}})).post()}var e=document.id("dialog_limiter"),t=e.getElement(".action"),n=null,r="'+escape((interp=key)==null?"":interp)+'";app.initCaptcha("limiter-captcha","other",function(e){n=e}),t.addEvent("click",i)})()</script>')}return buf.join("")},__t["dialog_box/move_pins"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({"data-name":"move_pins",style:"width: 440px; margin-left: -220px;","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">移动至...</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push(">");var __val__=emerge("base/board_list",{creationOnly:is_creation});buf.push(null==__val__?"":__val__),buf.push("<a"),buf.push(attrs({style:"margin-top: 20px",href:"#",onclick:"return false;","class":"go btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 批量移动</span></a></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div>")}return buf.join("")},__t["dialog_box/muse_upload"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp,creationOnly=locals.creationOnly||!1;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"image_upload","data-name":"upload","class":"muse dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">上传采集</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({style:"display: none;","class":"board select"})),buf.push(">");if(creationOnly){var __val__=emerge("base/board_list",{creationOnly:creationOnly,currentBoard:locals.current_board||"default"});buf.push(null==__val__?"":__val__)}else{var __val__=emerge("base/board_list",{creationAll:!0,currentBoard:locals.current_board||"default"});buf.push(null==__val__?"":__val__)}buf.push("</div><div"),buf.push(attrs({"class":"upload list"})),buf.push("><div"),buf.push(attrs({style:"display: none;","class":"shadow"})),buf.push("></div><div"),buf.push(attrs({id:"muse-upload-list"})),buf.push("></div></div><div"),buf.push(attrs({"class":"upload-area"})),buf.push("><div"),buf.push(attrs({"class":"normal"})),buf.push("><label"),buf.push(attrs({"class":"title"})),buf.push(">拖拽图片到本区域上传</label><label"),buf.push(attrs({"class":"click-info"})),buf.push(">或者<a"),buf.push(attrs({href:"javascript:void(0);","class":"brown-link"})),buf.push(">点击这里</a>上传</label><small"),buf.push(attrs({"class":"tips"})),buf.push(">每次最多上传 10 张，单张文件体积不超过 10 MB</small></div><div"),buf.push(attrs({style:"display: none;","class":"uploaded"})),buf.push("><label"),buf.push(attrs({"class":"title"})),buf.push(">拖动文件到本窗口以上传，或者<a"),buf.push(attrs({href:"javascript:void(0);","class":"brown-link"})),buf.push(">点击上传</a></label><div"),buf.push(attrs({id:"upload-text","class":"upload text"})),buf.push("></div></div><div"),buf.push(attrs({style:"display: none","class":"draging"})),buf.push("><div"),buf.push(attrs({"class":"note"})),buf.push(">释放鼠标以上传</div></div><div"),buf.push(attrs({"class":"dropzone"})),buf.push("></div></div><div"),buf.push(attrs({"class":"uploading"})),buf.push("></div></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"reject btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action accept btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 上传</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div><div"),buf.push(attrs({id:"pin-preview-template",style:"display: none","class":"dz-file-preview"})),buf.push("><div"),buf.push(attrs({"class":"pin-preview"})),buf.push("><div"),buf.push(attrs({"class":"dz-details preview"})),buf.push("><img"),buf.push(attrs({"data-dz-thumbnail":!0,"data-baiduimageplus-ignore":1})),buf.push("/></div><div"),buf.push(attrs({"class":"content"})),buf.push("><textarea"),buf.push(attrs({placeholder:"填写作品的相关描述","class":"description input"})),buf.push("></textarea></div><div"),buf.push(attrs({"class":"handler drag"})),buf.push("></div><div"),buf.push(attrs({"data-dz-remove":!0,"class":"handler remove"})),buf.push("></div><div"),buf.push(attrs({"class":"dz-progress"})),buf.push("><div"),buf.push(attrs({"data-dz-uploadprogress":!0,"class":"dz-progress-mark"})),buf.push(">上传中</div></div><div"),buf.push(attrs({"class":"dz-error-message"})),buf.push("><span"),buf.push(attrs({"data-dz-errormessage":!0})),buf.push('></span></div></div></div></div><script>(function(){function y(){g&&clearTimeout(g),g=setTimeout(function(){var e=window.getSize().y;c.set("styles",{"max-height":e/3})},300)}var e=document.id("image_upload"),t=e.getElement(".upload-area"),n=t.getElement(".normal"),r=t.getElement(".uploaded"),i=t.getElement(".draging"),s=e.getElement(".reject"),o=e.getElement("!~"),u=e.getElement(".dropzone"),a=e.getElement(".board.select"),f=e.getElement(".uploading"),l=document.id("muse-upload-list"),c=l.getParent(),h=e.getElement(".box-inner"),p=!1,d=app.req.user,v=10,m=new Request.JSON({onSuccess:function(e){if(e.hasOwnProperty("err"))return app.error(e.msg);var t=e.pin;if(e.warning&&100===e.warning)app.confirm(\'你已经在画板<a target="_blank" href="/boards/\'+t.board.board_id+\'/"><em>\'+t.board.title+"</em></a>中采集过这张图片，是否继续？",function(e){if(!e)return;delete m.options.data.check,m.post()});else{app.hideDialogBox("muse_upload");var n=app.$board_id,r=d.boards.filter(function(e){return e.board_id===n})[0];r&&r.extra&&r.extra.is_creation?app.showDialogBox("origin_succ",{user:d}):app.showDialogBox("pin_success",{muse:!0})}},onError:function(e){app.error(e)},onComplete:function(){f.hide()}}),g;s.addEvent("click",function(){app.hideDialogBox("muse_upload")}),c.addEvent("scroll",function(){var e=c.getScroll().y,t=c.getElement(".shadow");2<e?(t.show(),t.set("styles",{top:e})):t.hide()}),window.addEvent("resize",y),y(),e.getElement(".accept").addEvent("click",function(){var t=$$(".upload.list .pin-preview"),n=e.getElement(".board-list").get("data-board-id");if(!t.length)return app.alert("请先上传采集");if(!n||!n.length)return app.alert("请选择画板");var r=t.map(function(e){var t=e.get("data-file-id"),n=e.getElement(".description").get("value").trim();return{file_id:t,text:n}}),i={};url="/muse/pins/",i.pins=r,i.board_id=n,f.show(),app.$board_id=Number(n),m.options.data=i,m.options.url=url,m.post()});var b=function(){function s(e){var i=e.getAcceptedFiles(),s=$("upload-text");i.length?(t.addClass("preview"),a.show(),s.show(),n.hide(),r.show()):(t.removeClass("preview"),a.hide(),s.hide(),n.show(),r.hide());var o=Math.min(v,i.length),u="已选择 "+o+" 张，还可以选择 "+(v-o)+" 张";$("upload-text").set("text",u)}function o(e,t){var n=e.previewTemplate;t.cancelUpload(e),n.remove()}function f(){var e=t.getElement(".dropzone");if(!e)return;e.addClass("fullscreen"),e.inject(h)}function c(){var e=h.getElement(".dropzone");e.removeClass("fullscreen"),e.inject(t)}Dropzone.prototype.enqueueFile=function(e){if(e.status===Dropzone.ADDED&&e.accepted===!0){e.status=Dropzone.QUEUED;if(this.options.autoProcessQueue)return setTimeout(function(e){return function(){return e.processQueue()}}(this),0)}else e.accepted=!1};var e=new Dropzone(u,{url:"/upload/",maxFilesize:10,maxFiles:v,previewsContainer:l,previewTemplate:document.id("pin-preview-template").get("html"),acceptedFiles:"image/*"});e.on("dragenter",function(){n.hide(),r.hide(),i.show();var s=e.getAcceptedFiles();s.length&&f(),t.addClass("active")}),e.on("dragover",function(){n.hide(),r.hide(),i.show(),t.addClass("active")}),e.on("dragleave",function(){var s=e.getAcceptedFiles();s.length?(c(),r.show()):n.show(),i.hide(),t.removeClass("active")}),e.on("drop",function(){r.show(),i.hide(),t.removeClass("active");var n=e.getAcceptedFiles();n.length&&c()}),e.on("addedfile",function(t){var n=e.getAcceptedFiles();v<=n.length&&(app.alert("最多只能选择 "+v+" 张"),o(t,e))}),e.on("removedfile",function(t){s(e)}),e.on("canceled",function(){n.show()}),e.on("error",function(e,r){n.show(),i.hide(),t.removeClass("active"),app.error(r)}),e.on("success",function(t,n){var r=t.previewTemplate;r.getElement(".dz-progress").hide(),s(e);var i=n.id;r.set("data-file-id",i)}),h.addEventListener&&h.addEventListener("dragenter",function(){var t=e.getAcceptedFiles();t.length&&f()})};Asset.javascript("/js/lib/dropzone.js",{onLoad:b})})()</script>')}return buf.join("")},__t["dialog_box/old_upload"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"image_upload","data-name":"upload","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">上传采集</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"upload-area"})),buf.push("><div"),buf.push(attrs({"class":"normal"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"upload-btn btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 上传采集</span></a><div"),buf.push(attrs({style:"margin-top: 25px","class":"note"})),buf.push(">也可以拖拽图片到该区域，完成上传</div><div"),buf.push(attrs({style:"margin: 10px 0 25px","class":"sub"})),buf.push(">支持单张 10m 以内图片上传</div><div"),buf.push(attrs({style:"margin-top: 20px; font-size: 12px","class":"sub"})),buf.push(">[提示]请严格遵守保密法律法规，严禁在互联网上存储、处理、传输、发布涉密信息</div></div><div"),buf.push(attrs({style:"display: none","class":"draging"})),buf.push("><div"),buf.push(attrs({"class":"note"})),buf.push(">释放鼠标以上传</div></div><div"),buf.push(attrs({style:"display: none","class":"uploading"})),buf.push("><div"),buf.push(attrs({"class":"animate"})),buf.push(">上传中...</div></div><div"),buf.push(attrs({"class":"dropzone"})),buf.push("></div></div><div"),buf.push(attrs({"class":"links"})),buf.push("><div"),buf.push(attrs({"class":"part"})),buf.push("><a"),buf.push(attrs({target:"_blank",href:"/about/goodies","class":"brown-link"})),buf.push(">安装采集工具</a><div"),buf.push(attrs({"class":"description"})),buf.push(">一键采集互联网上的任意图片</div></div><div"),buf.push(attrs({"class":"part"})),buf.push("><a"),buf.push(attrs({href:"/all/","class":"brown-link"})),buf.push(">在站内逛逛</a><div"),buf.push(attrs({"class":"description"})),buf.push(">点击采集按钮，一键转采喜欢的图片</div></div></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("image_upload"),t=e.getElement(".upload-btn"),n=e.getElement(".upload-area"),r=n.getElement(".normal"),i=r.getElement(".note"),s=n.getElement(".uploading"),o=n.getElement(".draging"),u=e.getElement(".close-btn"),a=e.getElement("!~"),f=e.getElement(".dropzone"),l=!1,c=function(e){var t=app.imgURL(e,"fw192");app.hideDialogBox("old_upload");var n={media:t,w_w:e.width,h:e.height,file_id:e.id,description:"",url:"",title:"上传采集",req:app.req,name:e.name,cancel:!0,isMuse:!1,from:"upload"};app.req.user&&app.page.board&&app.req.user.user_id===app.page.board.user_id&&(n.current_board=app.page.board),app.showDialogBox("create_pin",n)},h=function(e){e.stop();if(s.getStyle("display")=="none")return app.hideDialogBox("old_upload");app.confirm("正在上传采集，要停止上传吗？",function(e){if(!e)return;l=!0,app.hideDialogBox("old_upload")})};a.addEvent("click",h),u.addEvent("click",h);if(Browser.ie&&Browser.version<10){i.hide();var p={start:function(){r.hide(),s.show(),l=!1},failed:function(e){r.show(),s.hide(),app.error("上传出错: "+(e.msg||app.COMMON_ERRMSG))},complete:function(e){if(l)return;c(e)}};(new Uploadr(t)).addEvents(p),f.hide()}else{var d=function(){var e=new Dropzone(f,{url:"/upload/",maxFilesize:10,maxFiles:1,acceptedFiles:"image/*"});e.on("dragenter",function(){r.hide(),o.show(),n.addClass("active")}),e.on("dragover",function(){r.hide(),o.show(),n.addClass("active")}),e.on("dragleave",function(){r.show(),o.hide(),n.removeClass("active")}),e.on("dragend",function(){r.show(),o.hide(),n.removeClass("active")}),e.on("sending",function(){r.hide(),s.show(),o.hide(),n.removeClass("active"),l=!1}),e.on("canceled",function(){r.show(),s.hide()}),e.on("error",function(t,i){r.show(),o.hide(),n.removeClass("active"),s.hide(),f.getElements(".dz-preview").destroy(),e.files.pop(),app.error(i)}),e.on("success",function(t,n){if(l)return;if(n.err)r.show(),s.hide(),f.getElements(".dz-preview").destroy(),e.files.pop(),app.error("上传出错: "+(n.msg||app.COMMON_ERRMSG));else{var i=["jpg","png","jpeg","gif","JPG","PNG","JPEG","GIF"],o=t.name.split(".");n.name=(o.length>1&&i.indexOf(o[o.length-1])!==-1?o.pop():o)&&o.join("."),c(n)}})};Asset.javascript("/js/lib/dropzone.js",{onLoad:d})}})()</script>')}return buf.join("")},__t["dialog_box/origin_alert"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"origin-alert","data-name":"upload","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">上传原创作品</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><div"),buf.push(attrs({"class":"selection"})),buf.push("><div"),buf.push(attrs({"class":"item clickable"})),buf.push("><div"),buf.push(attrs({"class":"title"})),buf.push(">上传原创作品</div><div"),buf.push(attrs({"class":"text"})),buf.push(">直接上传到画板，暂不登记版权</div></div><a"),buf.push(attrs({href:"http://meisubq.huaban.com/copyright/register/edit",target:"_blank","class":"item"})),buf.push("><div"),buf.push(attrs({"class":"title"})),buf.push(">上传并登记版权作品</div><div"),buf.push(attrs({"class":"text"})),buf.push(">将跳转到花瓣美素进行操作</div></a></div><div"),buf.push(attrs({"class":"tip"})),buf.push(">上传到美素的版权作品会同步到您的默认花瓣原创画板，<a"),buf.push(attrs({href:"http://faq.huaban.com/faq/dci-copyright-registration/#e698afe590a6e58fafe4bba5e79bb4e68ea5e59ca8e7be8ee7b4a0e4b88ae4bca0e4bd9ce59381efbc8ce5b9b6e799bbe8aeb0efbc9f"})),buf.push(">了解更多 »</a></div></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 关闭</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("origin-alert"),t=e.getElement(".item.clickable");t.addEvent("click",function(){app.hideDialogBox("origin_alert");var e={current_board:app.page.board,creationOnly:!0};app.showDialogBox("muse_upload",e)})})()</script>')}return buf.join("")},__t["dialog_box/origin_succ"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp,user=locals.user||{};buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"origin-succ","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">上传成功</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><p>成功上传原创作品到<a"),buf.push(attrs({href:"","class":"red-link board-link"})),buf.push("></a></p><p>拥有该作品版权？您可以<a"),buf.push(attrs({href:"/"+user.urlname+"/copyright","class":"red-link"})),buf.push(">登记版权作品</a></p></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"reject btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 关闭</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("origin-succ"),t=e.getElement(".board-link");e.getElement(".reject").addEvent("click",function(e){app.hideDialogBox("origin_succ")}),(new Request.JSON({url:"/boards/"+app.$board_id,onSuccess:function(e){if(e.err||!e.board)return;var n=e.board,r="/boards/"+n.board_id;t.set("href",r),t.set("text",n.title)},onError:function(e){app.error(e.responseText)}})).get()})()</script>')}return buf.join("")},__t["dialog_box/pin_success"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"pin_success","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">采集成功</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push(">");var isMuse=locals.muse;if(isMuse){var __val__=emerge("base/muse_pin_success");buf.push(null==__val__?"":__val__)}else{var __val__=emerge("base/pin_success");buf.push(null==__val__?"":__val__)}buf.push("</div><div"),buf.push(attrs({"class":"close-btn"})),buf.push("><i></i></div></div>")}return buf.join("")},__t["dialog_box/repin"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp,pin_id=locals.pin_id;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"repin_dialog","data-name":"repin","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-inner"})),buf.push(">");var __val__=emerge("base/pin_create",{pin_id:pin_id});buf.push(null==__val__?"":__val__),buf.push("</div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div><script>(function(){var e=document.id("repin_dialog"),t=e.getElement(".preview .description"),n=e.getElements(".shares .share"),r="'+escape((interp=locals.pin_id)==null?"":interp)+'",i=e.getElement(".common-message.info"),s=e.getElement(".preview img"),o=e.getElement(".boardlist"),u=e.getElement(".taginput");e.addEvent("click:relay(.box-warning .cancel)",function(){app.hideDialogBox("repin")}),(new Request.JSON({url:"/pins/"+r+"/repin/?check=true",onSuccess:function(e){if(e.err){app.hideDialogBox("repin"),app.error(e.msg||app.COMMON_ERRMSG);return}if(e.warning&&e.warning==100){i.show().innerHTML=\'这张图片已经在你的<a href="/boards/{board_id}/">{board_title}</a>画板里。\'.replace("{board_id}",e.exist_pin.board.board_id).replace("{board_title}",e.exist_pin.board.title);var n=420-i.offsetHeight-8;o.style.height=n+"px"}s.src=app.imgURL(e.pin.file,"fw236"),t.value=e.pin.raw_text}})).get()})()</script></div>')}return buf.join("")},__t["dialog_box/select_board"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"select-board","class":"dialog-box select-board"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">添加已有画板</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push(">");var __val__=emerge("base/board_list",{boardCreatable:!1,creationAll:!0});buf.push(null==__val__?"":__val__),buf.push("<p"),buf.push(attrs({"class":"tip"})),buf.push(">选择你已有原创作品的画板，请不要选择非原创的作品</p></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"cancel btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 添加</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("select-board"),t=e.getElement(".board-list"),n=e.getElements(".box-bottom .btn");n.addEvent("click",function(n){var r=!!this.hasClass("action");if(r){var i=t.get("data-board-id");if(!i.length)return app.alert("请选择已有原创作品的画板");var s=app.req.user.boards||[],o=s.filter(function(e){return e.board_id===Number(i)});e.fireEvent("confirm",o[0])}app.hideDialogBox("select_board"),n.stop()})})()</script>')}return buf.join("")},__t["dialog_box/tag_dialog"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({id:"tag-dialog","class":"dialog-box select-board"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">添加标签</div><div"),buf.push(attrs({"class":"box-inner"})),buf.push("><input"),buf.push(attrs({id:"tag-dialog-input","class":"clear-input"})),buf.push("/></div><div"),buf.push(attrs({"class":"box-bottom"})),buf.push("><div"),buf.push(attrs({"class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"cancel btn btn18"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 取消</span></a><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"action btn btn18 rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 添加</span></a></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.id("tag-dialog"),t=e.getElements(".box-bottom .btn"),n=new TagInput(document.id("tag-dialog-input"));t.addEvent("click",function(){app.hideDialogBox("tag_dialog");var t=!!this.hasClass("action");if(t){var r=n.getValue();e.fireEvent("confirm",{tags:r}),n.clear(),_czc.push(["_trackEvent","batch-tagging","tagcount",r.length])}})})()</script>')}return buf.join("")},__t["dialog_box/unbind"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push("<div"),buf.push(attrs({"class":"dialog-overlay"})),buf.push("></div><div"),buf.push(attrs({style:"width: 600px; margin-left: -360px;","class":"dialog-box"})),buf.push("><div"),buf.push(attrs({"class":"box-title"})),buf.push(">解绑第三方帐号</div><div"),buf.push(attrs({"class":"box-inner clearfix"})),buf.push("><div"),buf.push(attrs({id:"select"})),buf.push("><div"),buf.push(attrs({"class":"notice"})),buf.push(">为了您的帐号安全，在解绑第三方帐号前，您需要先验证登录邮箱或绑定手机号。</div><div"),buf.push(attrs({style:"margin-top:20px;","class":"buttons"})),buf.push("><a"),buf.push(attrs({href:"#",onclick:"return false;","class":"email_verify btn rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 邮箱验证</span></a><a"),buf.push(attrs({style:"margin-left: 20px;",href:"#",onclick:"return false;","class":"tel_verify btn rbtn"})),buf.push("><span"),buf.push(attrs({"class":"text"})),buf.push("> 手机号验证</span></a></div></div></div><div"),buf.push(attrs({"class":"close-btn"})),buf.push('><i></i></div></div><script>(function(){var e=document.getElements(".setting-unit"),t=document.id("select");t.getElement("a.email_verify").addEvent("click",function(t){Settings.closeUnit(document.id("_set_bindings")),Settings.openUnit(e,document.id("_set_email")),app.hideDialogBox("unbind"),t.stop()}),t.getElement("a.tel_verify").addEvent("click",function(t){Settings.closeUnit(document.id("_set_bindings")),Settings.openUnit(e,document.id("_tel_binding")),app.hideDialogBox("unbind"),t.stop()})})()</script>')}return buf.join("")},__t["dialog_box/upload"]=function(locals){var buf=[],buf=[];with(locals||{}){var interp;buf.push('<script>(function(){var e={};app.req.user&&app.page.board&&app.req.user.user_id===app.page.board.user_id&&(e={current_board:app.page.board}),(new Request.JSON({url:"/muse/me/status/",onSuccess:function(t){return t.hasOwnProperty("err")?app.showDialogBox("old_upload",!0):t.isMuseUser?app.showDialogBox("muse_upload",e):app.showDialogBox("old_upload",!0)},onError:function(){app.showDialogBox("old_upload",!0)}})).get()})()</script>')}return buf.join("")}})(app);